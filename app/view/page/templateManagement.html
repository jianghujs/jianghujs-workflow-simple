{% extends 'template/jhTemplateV4.html'%}

{% block vueTemplate %}

<script type="text/html" id="app-template">
  <div>
    <v-app mobile-breakpoint="sm">
      <jh-menu />
      <v-main class="mt-15">
        <!-- 头部内容 >>>>>>>>>>>>> -->
        <div class="jh-page-second-bar px-8">
          <div class="pt-3 text-h7 font-weight-bold">新申请审批
            <!-- 帮助页按钮 -->
            <v-icon @click="isHelpPageDrawerShown = true" color="success" small>mdi-help-circle-outline</v-icon>
          </div>
          <v-breadcrumbs class="pb-3 pt-0 px-0" :items="breadcrumbs" divider="-"></v-breadcrumbs>
        </div>
        <!-- <<<<<<<<<<<<< 头部内容 -->

        <div class="jh-page-body-container px-8">
          <!-- 页面内容 >>>>>>>>>>>>> -->
          <v-card class="rounded-lg mb-4" v-for="(template, tIndex) in templateList" :key="tIndex">
            <v-row class="ma-0 py-0 px-4">
              <!--新增按钮-->
              <v-col cols="12" xs="12" sm="12" md="12" xl="12" class="" style="border-bottom: 1px solid #eee;">
                {{template.group}}
              </v-col>
              <v-col cols="4" xs="4" sm="2" md="1" xl="1" class="pl-0" v-for="(work, index) in template.list">
                <div class="work-item-box">
                  <v-card 
                    @click="doUiAction('startCreateWorkflow', {formItemList: work.formItemList, group: template.group})"
                    outlined 
                    tile 
                    class="work-item-content d-flex justify-center align-center">
                    <div class="work-item-label d-flex flex-column justify-center align-center" >
                      <v-icon
                        class="mb-2"
                        large
                        :color="work.color"
                      >
                        {{work.icon}}
                      </v-icon>
                      {{work.name}}
                    </div>
                  </v-card>
                </div>
              </v-col>
            </v-row>
          </v-card>
          <!-- <<<<<<<<<<<<< 页面内容 -->
        </div>
        <!-- <<<<<<<<<<<<< 创建审批抽屉 -->
        <v-navigation-drawer v-model="isCreateDrawerShown" :permanent="isCreateDrawerShown" fixed temporary right width="80%"
          class="elevation-24">
          <v-form v-if="isCreateDrawerShown" ref="createForm" lazy-validation>
            <!--抽屉标题-->
            <v-row>
              <span class="title pa-6 pl-8">创建审批</span>
            </v-row>
            <!--抽屉表单主体-->
            <v-row class="mt-0 px-6">
              <v-col cols="12" sm="12" md="4" v-for="(item, index) in createFormList" :key="index">
                <form-item :form-item="item"></form-item>
              </v-col>

              <v-col cols="12" sm="12" md="4">
                <span class="jh-input-label">附件</span>
                xxx
              </v-col>
              <v-col cols="12" sm="12" md="12">
                <span class="jh-input-label">审批流程 - 添加审批人</span>
                <v-select
                  v-model="createItem.approver"
                  :items="userList"
                  item-text="text"
                  item-value="value"
                  multiple
                  dense single-line filled
                  :rules="validationRules.requireRules" 
                ></v-select>
              </v-col>
            </v-row>
            <!--抽屉操作按钮-->
            <v-row class="justify-end mx-0 mt-8 px-6">
              <v-btn color="success" @click="doUiAction('createWorkflow')" small>保存</v-btn>
              <v-btn class="ml-2" @click="isCreateDrawerShown = false" small>取消</v-btn>
            </v-row>
          </v-form>
          <!--抽屉关闭按钮-->
          <v-btn elevation="0" color="success" fab absolute top left small tile class="drawer-close-float-btn"
            @click="isCreateDrawerShown = false">
            <v-icon>mdi-close</v-icon>
          </v-btn>
        </v-navigation-drawer>
        <!-- 创建审批抽屉 >>>>>>>>>>>>> -->

      </v-main>
    </v-app>

    <jh-toast />
    <jh-mask />
    <jh-confirm-dialog />

  </div>
</script>

<div id="app">
</div>

{% endblock %}

{% block vueScript %}

<!-- 加载页面组件 >>>>>>>>>>>>> -->
{% include 'component/formItem.html' %}
<!-- <<<<<<<<<<<<< 加载页面组件 -->

<script type="module">
  new Vue({
    el: '#app',
    template: '#app-template',
    vueComponent: 'page',
    vuetify: new Vuetify(),
    data: {
      // 面包屑
      breadcrumbs: [
        {
          text: '首页',
          disabled: true,
        },
        {
          text: '模板',
          disabled: true,
        }
      ],
      validationRules: {
        requireRules: [
          v => !!v || 'This is required',
        ],
      },
      userList: [],
      templateList: [
        {
          group: '假勤',
          list: [
            { name: '请假', id: 'leave', icon: 'mdi-calendar-range', color: 'orange darken-2', formItemList: [
              {
                type: 'single',
                typeName: '单选',
                statement: '请假类型',
                answer: '',
                optionList: ['年假', '事假', '病假', '婚假', '产假', '其他']
              },
              {
                type: 'date',
                typeName: '时间',
                statement: '开始时间',
                answer: '',
              },
              {
                type: 'date',
                typeName: '时间',
                statement: '结束时间',
                answer: '',
              },
              {
                type: 'input',
                typeName: '文本',
                statement: '请假时长',
                answer: '',
              },
              {
                type: 'short',
                typeName: '文本框',
                statement: '请假事由',
                answer: '',
              },
            ] },
            { name: '加班', id: 'overtime', icon: 'mdi-account-clock', color: 'blue darken-2', formItemList: [
              {
                type: 'date',
                typeName: '时间',
                statement: '开始时间',
                answer: '',
              },
              {
                type: 'date',
                typeName: '时间',
                statement: '结束时间',
                answer: '',
              },
              {
                type: 'input',
                typeName: '文本',
                statement: '加班时长',
                answer: '',
              },
              {
                type: 'short',
                typeName: '文本框',
                statement: '加班事由',
                answer: '',
              },
            ] },
            { name: '出差', id: 'businessTrip', icon: 'mdi-airplane-takeoff', color: 'blue darken-2' },
            { name: '外出', id: 'out', icon: 'mdi-seat-outline', color: 'blue darken-2' },
            { name: '出勤', id: 'attendance', icon: 'mdi-account-clock', color: 'teal darken-2' },
            { name: '补卡', id: 'makeUpCard', icon: 'mdi-account-clock', color: 'blue darken-2' },
            { name: '调休', id: 'adjustRest', icon: 'mdi-account-clock', color: 'teal darken-2' },
            { name: '调班', id: 'adjustClass', icon: 'mdi-account-clock', color: 'blue darken-2' },
          ]
        },
        {
          group: '行政',
          list: [
            { name: '会议室预定', id: 'metting', icon: 'mdi-account-multiple-outline', color: 'green darken-2' },
            { name: '用车申请', id: 'car', icon: 'mdi-car-back', color: 'teal darken-2' },
            { name: '用印申请', id: 'seal', icon: 'mdi-network-outline', color: 'orange darken-2' },
            { name: '物品领用', id: 'goods', icon: 'mdi-network-outline', color: 'light-blue darken-2' },
            { name: '物品借用', id: 'goodsBorrow', icon: 'mdi-network-outline', color: 'indigo darken-2' },
            { name: '通用审批', id: 'goodsReturn', icon: 'mdi-check-network-outline', color: 'blue darken-2' },
          ]
        }
      ],
      isCreateDrawerShown: false,
      createFormList: [],
      createItem: {
        approver: [],
        group: '',
      }
    },
    watch: {},
    created() {
      this.getUserList();
    },
    methods: {
      async doUiAction(uiActionId, uiActionData) {
        switch (uiActionId) {
          case 'getTableData':
            await this.getTableData();
            break;
          case 'openTableZebraLineMenu':
            await this.openTableZebraLineMenu(uiActionData);
            break;
          case 'jumpToAssignmentPaper':
            await this.jumpToAssignmentPaper(uiActionData);
            break;
          case 'startCreateWorkflow':
            await this.prepareCreateFormData(uiActionData);
            await this.openCreateDrawer();
            break;
          case 'createWorkflow':
            await this.prepareCreateValidate();
            await this.confirmCreateItemDialog();
            await this.prepareDoCreateItem();
            await this.doCreateItem();
            await this.closeCreateDrawer();
            break;
          default:
            console.error("[doUiAction] uiActionId not find", { uiActionId });
            break;
        }
      },

      async getUserList() {
        const result = await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'templateManagement',
              actionId: 'selectUserList',
              actionData: {},
              orderBy: [{ column: 'userId', order: 'asc' }]
            }
          }
        });

        const userList = result.data.appData.resultData.rows;
        this.userList = userList.map(user => {
          return {
            text: user.username,
            value: user.userId
          }
        });
      },
      
      // ---------- 斑马纹开关 uiAction >>>>>>>>>> --------
      async openTableZebraLineMenu(funObj) {
        this.tableZebraLineMenuPosition.x = funObj.x -funObj.offsetX + 10;
        this.tableZebraLineMenuPosition.y = window.innerHeight - 50;
        this.isTableZebraLineMenuShown = !this.isTableZebraLineMenuShown;
      },
      // ---------- <<<<<<<<<< 斑马纹开关 uiAction --------


      async prepareCreateFormData({formItemList, group}) {
        if (!formItemList) {
          await window.confirmDialog({title: "温馨提示", content: "该项目尚未开放"});
          throw new Error("formItemList is null");
        }
        this.createFormList = formItemList;
        this.createItem.group = group;
      },

      async openCreateDrawer() {
        this.isCreateDrawerShown = true;
      },
      async prepareCreateValidate() {
        if(await this.$refs.createForm.validate()) {
          return true;
        }
        throw new Error("请完善表单信息")
      },
      async confirmCreateItemDialog() {
        if (await window.confirmDialog({title: "新增", content: "确定新增吗？"}) === false) {
          throw new Error("[confirmCreateFormDialog] 否");
        }
      },
      prepareDoCreateItem() {
        console.log('create', this.createFormList);
      },

      async doCreateItem() {
        await window.jhMask.show();
        
        await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'templateManagement',
              actionId: 'insertItem',
              actionData: {
                formItemList: this.createFormList,
                taskUserList: this.createItem.approver,
                group: this.createItem.group
              }
            }
          }
        })
        // await window.jhMask.hide();
        // await window.vtoast.success("新增学生成功");
      },
      async closeCreateDrawer() {
        this.isCreateDrawerShown = false;
      },
      // ---------- <<<<<<<<<<< 跳转考作业 --------
      jumpToAssignmentPaper(item) {
        window.location.href = "/<$ ctx.app.config.appId $>/page/assignmentPaper?articleId=" + item.articleId;
      }
      // ---------- 跳转考作业 >>>>>>>>>>>> --------
    }
  })
</script>

<style scoped>
  .work-item-box {
    padding: 50% 0;
    position: relative;
  }
  .work-item-content {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;

  }
  @media (max-width: 500px) {
    body [xs='4'] {
      flex: auto;
    }
  }
  
</style>
{% endblock %}
